@{
    ViewBag.Title = "Hỗ trợ khách hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Layout Chat */
    .chat-container {
        display: flex;
        height: 80vh;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0,0,0,0.05);
    }

    /* Sidebar */
    .chat-sidebar {
        width: 300px;
        border-right: 1px solid #eee;
        display: flex;
        flex-direction: column;
    }

    .chat-search {
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    .user-list {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .user-item {
        padding: 15px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f5;
        transition: 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .user-item:hover, .user-item.active {
            background-color: #e7f1ff;
        }

    .user-avatar {
        width: 40px;
        height: 40px;
        background: #0d6efd;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .user-info h6 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
    }

    .user-info p {
        margin: 0;
        font-size: 12px;
        color: #999;
    }

    /* Main Chat */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f8f9fa;
    }

    .chat-header {
        padding: 15px;
        background: white;
        border-bottom: 1px solid #eee;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .message {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
        font-size: 14px;
        position: relative;
        word-wrap: break-word;
    }

    .message-in {
        align-self: flex-start;
        background: white;
        border: 1px solid #eee;
        color: #333;
        border-bottom-left-radius: 2px;
    }

    .message-out {
        align-self: flex-end;
        background: #0d6efd;
        color: white;
        border-bottom-right-radius: 2px;
    }

    .msg-time {
        font-size: 10px;
        margin-top: 5px;
        opacity: 0.7;
        display: block;
        text-align: right;
    }

    .chat-input-area {
        padding: 15px;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
    }
</style>

<div class="chat-container">
    <div class="chat-sidebar">
        <div class="chat-search">
            <input type="text" class="form-control" placeholder="Tìm khách hàng...">
        </div>
        <ul class="user-list" id="userList">
            <li class="text-center p-3 text-muted"><div class="spinner-border spinner-border-sm"></div> Đang tải...</li>
        </ul>
    </div>

    <div class="chat-main">
        <div class="chat-header" id="chatHeader">
            <i class="bi bi-chat-dots"></i> Chọn một khách hàng để bắt đầu chat
        </div>

        <div class="chat-messages" id="chatBox"></div>

        <div class="chat-input-area" id="inputArea" style="display:none;">
            <input type="text" id="msgInput" class="form-control" placeholder="Nhập tin nhắn...">
            <button class="btn btn-primary rounded-circle" onclick="sendMessage()">
                <i class="bi bi-send"></i>
            </button>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        var currentUserId = 0;

        $(document).ready(function () {
            loadUsers();

            // Tự động refresh tin nhắn mỗi 3 giây để tạo cảm giác Realtime
            setInterval(function () {
                if (currentUserId > 0) loadHistory(currentUserId, false); // false = không hiện loading
            }, 3000);
        });

        function loadUsers() {
            $.get('/Chat/GetUsers', function (data) {
                console.log(data); // Thêm dòng này để debug xem dữ liệu trả về là gì (F12 -> Console)

                var html = '';
                if (!data || data.length === 0) {
                    html = '<li class="p-3 text-center text-muted">Chưa có tin nhắn nào.</li>';
                } else {
                    data.forEach(u => {
                        // Dùng toán tử || để dự phòng nếu tên trường bị sai hoa thường
                        var ten = u.HoTen || u.hoTen || "Không tên";
                        var mail = u.Email || u.email || "";
                        var id = u.MaND || u.maND;

                        // Lấy chữ cái đầu
                        var avatarChar = ten.charAt(0).toUpperCase();

                        html += `
                    <li class="user-item" onclick="selectUser(${id}, '${ten}', this)">
                        <div class="user-avatar">${avatarChar}</div>
                        <div class="user-info">
                            <h6>${ten}</h6>
                            <p>${mail}</p>
                        </div>
                    </li>
                `;
                    });
                }
                $('#userList').html(html);
            });
        }

        // 2. Chọn User để chat
        function selectUser(id, name, element) {
            currentUserId = id;

            // Đổi màu dòng được chọn
            $('.user-item').removeClass('active');
            $(element).addClass('active');

            // Cập nhật Header
            $('#chatHeader').html(`<div class="user-avatar bg-primary text-white me-2" style="width:30px;height:30px;font-size:14px;">${name.charAt(0)}</div> Chat với: ${name}`);
            $('#inputArea').show();

            // Tải lịch sử (có hiện loading)
            loadHistory(id, true);
        }

        // 3. Tải lịch sử chat
        function loadHistory(id, showLoading) {
            if (showLoading) $('#chatBox').html('<div class="text-center mt-3"><div class="spinner-border text-primary"></div></div>');

            $.get('/Chat/GetHistory?id=' + id, function (msgs) {
                var html = '';
                if (msgs && msgs.length > 0) {
                    msgs.forEach(m => {
                        // Phân biệt tin nhắn Admin (bên phải) và User (bên trái)
                        var type = m.Sender === 'Admin' ? 'message-out' : 'message-in';
                        html += `
                                <div class="message ${type}">
                                    ${m.Content}
                                    <span class="msg-time">${m.Time}</span>
                                </div>
                            `;
                    });
                } else {
                    html = '<div class="text-center text-muted mt-5">Chưa có nội dung chat.</div>';
                }

                // Chỉ cập nhật HTML nếu nội dung thay đổi (để tránh giật khi auto refresh)
                var currentHtml = $('#chatBox').html();
                // So sánh độ dài chuỗi đơn giản để check thay đổi
                if (showLoading || html.length != currentHtml.length) {
                    $('#chatBox').html(html);
                    scrollToBottom();
                }
            });
        }

        // 4. Gửi tin
        function sendMessage() {
            var msg = $('#msgInput').val().trim();
            if (!msg || currentUserId === 0) return;

            // Hiện tin nhắn giả lập ngay lập tức cho mượt
            var tempHtml = `<div class="message message-out">${msg}<span class="msg-time">Đang gửi...</span></div>`;
            $('#chatBox').append(tempHtml);
            scrollToBottom();
            $('#msgInput').val('');

            // Gọi AJAX gửi tin
            $.post('/Chat/SendMessage', { maND: currentUserId, message: msg }, function (res) {
                if (res.success) {
                    loadHistory(currentUserId, false); // Load lại để cập nhật thời gian
                }
            });
        }

        // Nhấn Enter để gửi
        $('#msgInput').keypress(function (e) {
            if (e.which == 13) sendMessage();
        });

        function scrollToBottom() {
            var d = $('#chatBox');
            d.scrollTop(d.prop("scrollHeight"));
        }
    </script>
}