@model IEnumerable<QUANLYDICHVUDULICH.ADMIN.Models.TourViewModel>

@{
    ViewBag.Title = "Quản lý Tour";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Card bao quanh nội dung */
    .content-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        padding: 20px;
        min-height: 80vh;
    }

    /* Ảnh nhỏ trong bảng */
    .tour-thumb {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }

    /* Style cho bảng */
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        color: #495057;
        font-weight: 600;
    }
</style>

<div class="text-end mb-3">
    <button class="btn btn-primary" onclick="openModal(0)">
        <i class="bi bi-plus-lg"></i> Thêm Tour Mới
    </button>
</div>

<div class="content-card">
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th style="width: 80px;">Hình</th>
                    <th>Tên Tour</th>
                    <th>Giá</th>
                    <th>Thời lượng</th>
                    <th>Trạng thái</th>
                    <th class="text-center">Tác vụ</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>
                                <img src="@(string.IsNullOrEmpty(item.HinhAnhDaiDien) ? "https://placehold.co/60x60?text=No+Img" : item.HinhAnhDaiDien)"
                                     class="tour-thumb"
                                     onerror="this.src='https://placehold.co/60x60?text=Error'">
                            </td>
                            <td class="fw-bold">@item.TenTour</td>
                            <td class="text-primary fw-bold">@string.Format("{0:N0} đ", item.GiaGoc)</td>
                            <td>@item.ThoiLuongNgay ngày</td>
                            <td>
                                <span class="badge @(item.TrangThai == "Đang mở bán" ? "bg-success" : "bg-secondary")">
                                    @item.TrangThai
                                </span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="openModal(@item.MaTour)" title="Sửa">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTour(@item.MaTour)" title="Xóa">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1"></i>
                            <p class="mb-0">Không tìm thấy tour nào.</p>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="tourModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Thông tin Tour</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Đang tải dữ liệu...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveTour()">Lưu lại</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // 1. Mở Modal (Gọi Partial View từ Controller)
        function openModal(id) {
            $('#modalTitle').text(id === 0 ? "Thêm Tour Mới" : "Cập nhật Tour");
            var myModal = new bootstrap.Modal(document.getElementById('tourModal'));
            myModal.show();

            // Gọi AJAX lấy form
            $.get('@Url.Action("GetModal", "Tour")', { id: id })
                .done(function (data) {
                    $('#modalBody').html(data);
                })
                .fail(function() {
                    $('#modalBody').html('<div class="alert alert-danger text-center">Không thể tải biểu mẫu. Vui lòng thử lại!</div>');
                });
        }

        // 2. Lưu Dữ Liệu (Dùng FormData để gửi được cả Ảnh + Text)
        function saveTour() {
            var form = document.getElementById('frmTour');

            // Kiểm tra form có tồn tại không
            if (!form) {
                Swal.fire('Lỗi', 'Không tìm thấy biểu mẫu!', 'error');
                return;
            }

            // Kiểm tra validate cơ bản (HTML5 required)
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            var formData = new FormData(form);

            // Hiển thị loading
            Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });

            $.ajax({
                url: '@Url.Action("Save", "Tour")',
                type: 'POST',
                data: formData,
                processData: false, // Bắt buộc false khi gửi file
                contentType: false, // Bắt buộc false khi gửi file
                success: function (res) {
                    if (res.success) {
                        $('#tourModal').modal('hide');
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: res.message,
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            location.reload(); // Tải lại trang
                        });
                    } else {
                        Swal.fire('Thất bại', res.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Lỗi', 'Không thể kết nối đến máy chủ.', 'error');
                }
            });
        }

        // 3. Xóa Tour (Có cảnh báo)
        function deleteTour(id) {
            Swal.fire({
                title: 'Bạn có chắc chắn?',
                text: "Dữ liệu sẽ bị xóa vĩnh viễn!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa ngay',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hiển thị loading
                    Swal.fire({ title: 'Đang xóa...', didOpen: () => Swal.showLoading() });

                    $.post('@Url.Action("Delete", "Tour")', { id: id })
                        .done(function (res) {
                            if (res.success) {
                                Swal.fire('Đã xóa!', 'Xóa thành công.', 'success')
                                    .then(() => location.reload());
                            } else {
                                // Hiển thị lỗi chi tiết từ Server gửi về (VD: Ràng buộc khóa ngoại)
                                Swal.fire('Không thể xóa', res.message, 'error');
                            }
                        })
                        .fail(function (xhr) {
                            console.error(xhr);
                            Swal.fire('Lỗi Server', 'Kiểm tra lại kết nối API.', 'error');
                        });
                }
            })
        }
    </script>
}