@model IEnumerable<QUANLYDICHVUDULICH.ADMIN.Models.DatTourViewModel>

@{
    ViewBag.Title = "Quản lý Đơn đặt Tour";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    /* --- CSS GIỮ NGUYÊN NHƯ CŨ --- */
    body {
        background-color: #f5f7fa;
    }

    .page-header-block {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .page-title {
        font-size: 24px;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0;
    }

    .content-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        padding: 20px;
    }

    .filter-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .search-box {
        flex-grow: 1;
        position: relative;
    }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background-color: #f8f9fa;
            outline: none;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
        }

    .filter-dropdown {
        padding: 10px 15px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        background-color: white;
        color: #495057;
        min-width: 160px;
    }

    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

        .custom-table th {
            text-transform: uppercase;
            font-size: 12px;
            color: #adb5bd;
            font-weight: 600;
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
            text-align: left;
        }

        .custom-table td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
            color: #343a40;
            font-size: 14px;
        }

    /* Badge Status */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
    }

    .st-waiting {
        background-color: #fff3cd;
        color: #856404;
    }

    .st-confirmed {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .st-paid {
        background-color: #cff4fc;
        color: #055160;
    }

    .st-cancel {
        background-color: #f8d7da;
        color: #842029;
    }

    /* Action Buttons */
    .btn-action {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        color: white;
        margin-right: 5px;
        transition: 0.2s;
        border: none;
        display: inline-block;
        cursor: pointer;
    }

    .btn-approve {
        background-color: #198754;
    }

        .btn-approve:hover {
            background-color: #157347;
            color: white;
        }

    .btn-cancel {
        background-color: #ffc107;
        color: #000;
    }

        .btn-cancel:hover {
            background-color: #ffca2c;
            color: #000;
        }

    .btn-delete {
        background-color: #dc3545;
    }

        .btn-delete:hover {
            background-color: #bb2d3b;
            color: white;
        }
</style>

<div class="page-header-block">
    <div>
        <p class="page-subtitle">Xem và quản lý tất cả các đơn đặt tour trong hệ thống.</p>
    </div>
</div>

<div class="content-card">
    <!-- Filter Bar -->
    <div class="filter-bar">
        @using (Html.BeginForm("Index", "DatTour", FormMethod.Get, new { style = "flex-grow:1; display:flex; gap:15px;" }))
        {
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" name="searchString" placeholder="Tìm kiếm theo mã đơn, tên khách..." value="@Request.QueryString["searchString"]">
            </div>
            <select class="filter-dropdown" name="status">
                <option>Tất cả trạng thái</option>
                <option value="Chờ xác nhận">Chờ xác nhận</option>
                <option value="Đã xác nhận">Đã xác nhận</option>
                <option value="Đã thanh toán">Đã thanh toán</option>
            </select>
            <button type="submit" style="display:none"></button>
        }
    </div>

    <!-- Table -->
    <table class="custom-table">
        <thead>
            <tr>
                <th style="width: 50px;">Mã</th>
                <th>Khách hàng</th>
                <th>Tour</th>
                <th>Ngày đi</th>
                <th>Tổng tiền</th>
                <th>Trạng thái</th>
                <th style="text-align: center; width: 220px;">Hành động</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <tr>
                        <td style="font-weight:bold; color: #0d6efd;">#@item.MaDatTour</td>
                        <td><div style="font-weight: 600;">@item.TenKhachHang</div></td>
                        <td>@item.TenTour</td>
                        <td>@String.Format("{0:dd/MM/yyyy}", item.NgayKhoiHanh)</td>
                        <td style="font-weight:bold;">@String.Format("{0:N0} đ", item.TongTien)</td>
                        <td>
                            @if (item.TrangThai == "Chờ xác nhận")
                            {<span class="status-badge st-waiting">Chờ xác nhận</span> }
                            else if (item.TrangThai == "Đã xác nhận")
                            { <span class="status-badge st-confirmed">Đã xác nhận</span> }
                            else if (item.TrangThai == "Đã thanh toán")
                            { <span class="status-badge st-paid">@item.TrangThai</span> }
                        else
                        { <span class="status-badge st-cancel">@item.TrangThai</span>}
                        </td>
                        <td style="text-align: center;">
                            @if (item.TrangThai == "Chờ xác nhận")
                            {
                                <!-- Nút Duyệt: Gọi updateStatus -->
                                <button type="button" class="btn-action btn-approve" title="Duyệt đơn" onclick="updateStatus(@item.MaDatTour, 'Approve')">Duyệt</button>
                                <!-- Nút Hủy: Gọi updateStatus -->
                                <button type="button" class="btn-action btn-cancel" title="Hủy đơn" onclick="updateStatus(@item.MaDatTour, 'Cancel')">Hủy</button>
                            }
                            else if (item.TrangThai == "Đã xác nhận")
                            {
                                <button type="button" class="btn-action btn-cancel" onclick="updateStatus(@item.MaDatTour, 'Cancel')">Hủy</button>
                            }

                            <!-- Nút Xóa: Gọi deleteOrder -->
                            <button type="button" class="btn-action btn-delete" onclick="deleteOrder(@item.MaDatTour)">Xóa</button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="7" style="text-align:center; padding:30px; color:#999;">Chưa có đơn đặt tour nào.</td></tr>
            }
        </tbody>
    </table>
</div>

@section scripts {
    <!-- Thư viện jQuery & SweetAlert2 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // 1. Hàm Xóa Đơn Hàng (Delete)
        function deleteOrder(id) {
            Swal.fire({
                title: 'Xóa đơn hàng này?',
                text: "Dữ liệu sẽ mất vĩnh viễn!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa ngay',
                cancelButtonText: 'Quay lại'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Đang xử lý...', showConfirmButton: false, didOpen: () => { Swal.showLoading() } });

                    $.post('@Url.Action("Delete", "DatTour")', { id: id })
                        .done(function (res) {
                            if (res.success) {
                                Swal.fire('Thành công!', res.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Lỗi', res.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Lỗi Server', 'Không thể kết nối API.', 'error');
                        });
                }
            });
        }

        // 2. Hàm Cập nhật trạng thái (Duyệt / Hủy)
        function updateStatus(id, actionType) {
            var titleText = actionType === 'Approve' ? 'Duyệt đơn hàng này?' : 'Hủy đơn hàng này?';
            var btnColor = actionType === 'Approve' ? '#198754' : '#ffc107';
            var btnText = actionType === 'Approve' ? 'Duyệt ngay' : 'Đồng ý hủy';

            // Chọn Action Url dựa vào loại hành động
            var urlAction = actionType === 'Approve' ? '@Url.Action("Approve", "DatTour")' : '@Url.Action("Cancel", "DatTour")';

            Swal.fire({
                title: titleText,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: btnColor,
                confirmButtonText: btnText,
                cancelButtonText: 'Đóng'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Đang cập nhật...', showConfirmButton: false, didOpen: () => { Swal.showLoading() } });

                    $.post(urlAction, { id: id })
                        .done(function (res) {
                            if (res.success) {
                                Swal.fire('Thành công!', res.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Lỗi', res.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Lỗi Server', 'Không thể kết nối API.', 'error');
                        });
                }
            });
        }
    </script>
}