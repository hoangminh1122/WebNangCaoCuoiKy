@model IEnumerable<QUANLYDICHVUDULICH.ADMIN.Models.KhachHangViewModel>

@{
    ViewBag.Title = "Quản lý Khách hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    /* --- CSS GIỮ NGUYÊN --- */
    body {
        background-color: #f5f7fa;
        font-family: 'Segoe UI', sans-serif;
    }

    .content-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.03);
        padding: 25px;
        min-height: 80vh;
    }

    .filter-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .search-box {
        position: relative;
        flex-grow: 1;
        margin-right: 20px;
    }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 45px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

    .btn-filter {
        border: 1px solid #e2e8f0;
        background: white;
        color: #4a5568;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s;
        margin-right: 5px;
    }

        .btn-filter.active {
            background-color: #ebf8ff;
            color: #3182ce;
            border-color: #3182ce;
            font-weight: 600;
        }

        .btn-filter:hover {
            background-color: #edf2f7;
        }

    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

        .custom-table th {
            text-align: left;
            color: #718096;
            font-weight: 600;
            font-size: 13px;
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
        }

        .custom-table td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
            font-size: 14px;
        }

    .user-name {
        font-weight: 600;
        color: #2d3748;
    }

    .user-email {
        color: #718096;
        font-size: 13px;
    }

    .badge-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .badge-active {
        background-color: #c6f6d5;
        color: #22543d;
    }

    .badge-locked {
        background-color: #fed7d7;
        color: #822727;
    }

    .action-icon {
        color: #718096;
        font-size: 16px;
        margin-left: 10px;
        cursor: pointer;
        transition: 0.2s;
        border: none;
        background: none;
    }

        .action-icon:hover {
            color: #3182ce;
        }

    .action-lock:hover {
        color: #e53e3e;
    }

    .action-unlock:hover {
        color: #38a169;
    }

    .action-delete:hover {
        color: #dc3545;
    }

    .custom-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
</style>

<div class="content-card">
    <div class="filter-wrapper justify-content-end">
        @using (Html.BeginForm("Index", "KhachHang", FormMethod.Get, new { id = "filterForm" }))
        {
            <input type="hidden" name="searchString" value="@Request.QueryString["searchString"]" />

            <div style="display:flex;">
                @{ string s = Request.QueryString["statusFilter"]; }
                <button type="submit" name="statusFilter" value="" class="btn-filter @(string.IsNullOrEmpty(s) ? "active" : "")">Tất cả</button>
                <button type="submit" name="statusFilter" value="active" class="btn-filter @(s == "active" ? "active" : "")">Hoạt động</button>
                <button type="submit" name="statusFilter" value="locked" class="btn-filter @(s == "locked" ? "active" : "")">Bị khóa</button>
            </div>
        }
    </div>

    <table class="custom-table">
        <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" class="custom-checkbox"></th>
                <th>Họ và Tên</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Ngày đăng ký</th>
                <th>Trạng thái</th>
                <th style="text-align: right;">Hành động</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <tr>
                        <td><input type="checkbox" class="custom-checkbox"></td>
                        <td><div class="user-name">@item.HoTen</div></td>
                        <td class="user-email">@item.Email</td>
                        <td>@item.SoDienThoai</td>
                        <td>@item.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td>
                            @if (item.TrangThai)
                            {<span class="badge-status badge-active">Hoạt động</span> }
                            else
                            { <span class="badge-status badge-locked">Bị khóa</span>}
                        </td>
                        <td style="text-align: right;">
                            <button class="action-icon" title="Xem chi tiết" onclick="viewDetails(@item.MaND)">
                                <i class="far fa-eye"></i>
                            </button>

                            @if (item.TrangThai)
                            {
                                <button type="button" class="action-icon action-lock" title="Khóa tài khoản" onclick="toggleStatus(@item.MaND, true)">
                                    <i class="fas fa-lock-open"></i>
                                </button>
                            }
                            else
                            {
                                <button type="button" class="action-icon action-unlock" title="Mở khóa tài khoản" onclick="toggleStatus(@item.MaND, false)">
                                    <i class="fas fa-lock"></i>
                                </button>
                            }

                            <button type="button" class="action-icon action-delete" title="Xóa khách hàng" onclick="deleteCustomer(@item.MaND)">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="7" style="text-align:center; padding: 40px; color: #a0aec0;">Không tìm thấy khách hàng nào.</td></tr>
            }
        </tbody>
    </table>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
        <span style="color: #718096; font-size: 14px;">Hiển thị @(Model != null ? Model.Count() : 0) kết quả</span>
    </div>
</div>

<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold ps-2">Hồ sơ khách hàng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img id="viewAvatar" src="" class="rounded-circle mb-3 shadow-sm" style="width: 100px; height: 100px; object-fit:cover;">

                <h4 id="viewName" class="fw-bold mb-1"></h4>
                <p id="viewEmail" class="text-muted mb-3"></p>

                <span id="viewStatus" class="badge-status mb-4"></span>

                <div class="card bg-light border-0 text-start">
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-5 text-muted"><i class="fas fa-id-card me-2"></i> Mã KH:</div>
                            <div class="col-7 fw-bold" id="viewMaND"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 text-muted"><i class="fas fa-phone me-2"></i> SĐT:</div>
                            <div class="col-7 fw-bold" id="viewPhone"></div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-5 text-muted"><i class="fas fa-calendar-alt me-2"></i> Ngày tạo:</div>
                            <div class="col-7 fw-bold" id="viewDate"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Hàm Xem Chi Tiết
        function viewDetails(id) {
            Swal.fire({ title: 'Đang tải...', didOpen: () => Swal.showLoading() });

            // Gọi hàm GetJsonKhachHang từ Controller
            $.get('/KhachHang/GetJsonKhachHang?id=' + id, function(data) {
                Swal.close();
                if(data) {
                    $('#viewMaND').text('#' + data.MaND);
                    $('#viewName').text(data.HoTen);
                    $('#viewEmail').text(data.Email);
                    $('#viewPhone').text(data.SoDienThoai);

                    // Fix lỗi ngày tháng
                    const formatDate = (d) => {
                        if(!d) return '...';
                        if (typeof d === 'string' && d.includes('/Date(')) {
                            return new Date(parseInt(d.match(/\d+/)[0])).toLocaleDateString('vi-VN');
                        }
                        var date = new Date(d);
                        return isNaN(date.getTime()) ? '...' : date.toLocaleDateString('vi-VN');
                    };
                    $('#viewDate').text(formatDate(data.NgayTao));

                    // Status badge
                    var badge = $('#viewStatus');
                    if(data.TrangThai) {
                        badge.text('Hoạt động').removeClass('badge-locked').addClass('badge-active');
                    } else {
                        badge.text('Bị khóa').removeClass('badge-active').addClass('badge-locked');
                    }

                    // Avatar (Dùng UI Avatars)
                    $('#viewAvatar').attr('src', 'https://ui-avatars.com/api/?name=' + encodeURIComponent(data.HoTen) + '&background=random&size=150');

                    var myModal = new bootstrap.Modal(document.getElementById('customerModal'));
                    myModal.show();
                } else {
                    Swal.fire('Lỗi', 'Không tìm thấy dữ liệu', 'error');
                }
            }).fail(function() {
                Swal.fire('Lỗi', 'Không kết nối được server', 'error');
            });
        }

        // 2. Hàm Khóa / Mở Khóa
        function toggleStatus(id, willLock) {
            var titleText = willLock ? 'Khóa tài khoản này?' : 'Mở khóa tài khoản?';
            var btnText = willLock ? 'Khóa ngay' : 'Mở khóa';
            var btnColor = willLock ? '#e53e3e' : '#38a169';

            Swal.fire({
                title: titleText,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: btnColor,
                confirmButtonText: btnText,
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Đang xử lý...', didOpen: () => { Swal.showLoading() } });
                    $.post('@Url.Action("ToggleStatus", "KhachHang")', { id: id })
                        .done(function (res) {
                            if (res.success) Swal.fire('Thành công!', res.message, 'success').then(() => location.reload());
                            else Swal.fire('Lỗi', res.message, 'error');
                        })
                        .fail(function() { Swal.fire('Lỗi', 'Lỗi kết nối server', 'error'); });
                }
            });
        }

        // 3. Hàm Xóa
        function deleteCustomer(id) {
            Swal.fire({
                title: 'Xóa khách hàng?',
                text: "Dữ liệu sẽ mất vĩnh viễn!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Xóa ngay',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Đang xóa...', didOpen: () => { Swal.showLoading() } });
                    $.post('@Url.Action("Delete", "KhachHang")', { id: id })
                        .done(function (res) {
                            if (res.success) Swal.fire('Đã xóa!', res.message, 'success').then(() => location.reload());
                            else Swal.fire('Không thể xóa', res.message, 'error');
                        })
                        .fail(function() { Swal.fire('Lỗi', 'Lỗi kết nối server', 'error'); });
                }
            });
        }
    </script>
}