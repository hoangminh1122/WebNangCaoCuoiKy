@model IEnumerable<QUANLYDICHVUDULICH.ADMIN.Models.KhachHangViewModel>

@{
    ViewBag.Title = "Quản lý Khách hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    /* CSS giữ nguyên, chỉ xóa phần search-box không dùng đến */
    body {
        background-color: #f5f7fa;
        font-family: 'Segoe UI', sans-serif;
    }

    .content-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.03);
        padding: 25px;
        min-height: 80vh;
    }

    /* Filter Buttons */
    .btn-filter {
        border: 1px solid #e2e8f0;
        background: white;
        color: #4a5568;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s;
        margin-right: 5px;
    }

        .btn-filter.active {
            background-color: #ebf8ff;
            color: #3182ce;
            border-color: #3182ce;
            font-weight: 600;
        }

        .btn-filter:hover {
            background-color: #edf2f7;
        }

    /* Table */
    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 15px;
    }

        .custom-table th {
            text-align: left;
            color: #718096;
            font-weight: 600;
            font-size: 13px;
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
        }

        .custom-table td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
            font-size: 14px;
        }

    .user-name {
        font-weight: 600;
        color: #2d3748;
    }

    .user-email {
        color: #718096;
        font-size: 13px;
    }

    /* Badges */
    .badge-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .badge-active {
        background-color: #c6f6d5;
        color: #22543d;
    }

    .badge-locked {
        background-color: #fed7d7;
        color: #822727;
    }

    /* Actions */
    .action-icon {
        color: #718096;
        font-size: 16px;
        margin-left: 10px;
        cursor: pointer;
        transition: 0.2s;
        border: none;
        background: none;
    }

        .action-icon:hover {
            color: #3182ce;
        }

    .action-lock:hover {
        color: #e53e3e;
    }

    .action-unlock:hover {
        color: #38a169;
    }

    .action-delete:hover {
        color: #dc3545;
    }

    .custom-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
</style>

<div class="content-card">

    @using (Html.BeginForm("Index", "KhachHang", FormMethod.Get))
    {
        <div style="display: flex; justify-content: flex-end; align-items: center;">

            <input type="hidden" name="searchString" value="@Request.QueryString["searchString"]" />

            <div style="display:flex;">
                @{ string s = Request.QueryString["statusFilter"]; }
                <button type="submit" name="statusFilter" value="" class="btn-filter @(string.IsNullOrEmpty(s) ? "active" : "")">Tất cả</button>
                <button type="submit" name="statusFilter" value="active" class="btn-filter @(s == "active" ? "active" : "")">Hoạt động</button>
                <button type="submit" name="statusFilter" value="locked" class="btn-filter @(s == "locked" ? "active" : "")">Bị khóa</button>
            </div>
        </div>
    }

    <table class="custom-table">
        <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" class="custom-checkbox"></th>
                <th>Họ và Tên</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Ngày đăng ký</th>
                <th>Trạng thái</th>
                <th style="text-align: right;">Hành động</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <tr>
                        <td><input type="checkbox" class="custom-checkbox"></td>
                        <td><div class="user-name">@item.HoTen</div></td>
                        <td class="user-email">@item.Email</td>
                        <td>@item.SoDienThoai</td>
                        <td>@item.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td>
                            @if (item.TrangThai)
                            {<span class="badge-status badge-active">Hoạt động</span> }
                            else
                            { <span class="badge-status badge-locked">Bị khóa</span>}
                        </td>
                        <td style="text-align: right;">
                            <button class="action-icon" title="Xem chi tiết"><i class="far fa-eye"></i></button>

                            @if (item.TrangThai)
                            {
                                <button type="button" class="action-icon action-lock" title="Khóa tài khoản" onclick="toggleStatus(@item.MaND, true)">
                                    <i class="fas fa-lock-open"></i>
                                </button>
                            }
                            else
                            {
                                <button type="button" class="action-icon action-unlock" title="Mở khóa tài khoản" onclick="toggleStatus(@item.MaND, false)">
                                    <i class="fas fa-lock"></i>
                                </button>
                            }

                            <button type="button" class="action-icon action-delete" title="Xóa khách hàng" onclick="deleteCustomer(@item.MaND)">
                                <i class="far fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px; color: #a0aec0;">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 10px;"></i><br />
                        Không tìm thấy khách hàng nào.
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
        <span style="color: #718096; font-size: 14px;">Hiển thị @(Model != null ? Model.Count() : 0) kết quả</span>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // 1. Hàm Khóa / Mở Khóa
        function toggleStatus(id, willLock) {
            var titleText = willLock ? 'Khóa tài khoản này?' : 'Mở khóa tài khoản?';
            var btnText = willLock ? 'Khóa ngay' : 'Mở khóa';
            var btnColor = willLock ? '#e53e3e' : '#38a169';
            var iconType = willLock ? 'warning' : 'question';

            Swal.fire({
                title: titleText,
                text: willLock ? "Người dùng sẽ không thể đăng nhập." : "Người dùng sẽ hoạt động lại.",
                icon: iconType,
                showCancelButton: true,
                confirmButtonColor: btnColor,
                confirmButtonText: btnText,
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Đang xử lý...', didOpen: () => { Swal.showLoading() } });
                    $.post('@Url.Action("ToggleStatus", "KhachHang")', { id: id })
                        .done(function (res) {
                            if (res.success) Swal.fire('Thành công!', res.message, 'success').then(() => location.reload());
                            else Swal.fire('Lỗi', res.message, 'error');
                        });
                }
            });
        }

        // 2. Hàm Xóa
        function deleteCustomer(id) {
            Swal.fire({
                title: 'Xóa khách hàng?',
                text: "Dữ liệu sẽ mất vĩnh viễn! (Chỉ xóa nếu khách chưa từng đặt tour)",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Xóa ngay',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Đang xóa...', didOpen: () => { Swal.showLoading() } });
                    $.post('@Url.Action("Delete", "KhachHang")', { id: id })
                        .done(function (res) {
                            if (res.success) Swal.fire('Đã xóa!', res.message, 'success').then(() => location.reload());
                            else Swal.fire('Không thể xóa', res.message, 'error');
                        });
                }
            });
        }
    </script>
}