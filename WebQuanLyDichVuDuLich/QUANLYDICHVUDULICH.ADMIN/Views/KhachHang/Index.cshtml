@model IEnumerable<QUANLYDICHVUDULICH.ADMIN.Models.KhachHangViewModel>

@{
    ViewBag.Title = "Quản lý Khách hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<style>
    body {
        background-color: #f5f7fa;
        font-family: 'Segoe UI', sans-serif;
    }

    .content-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.03);
        padding: 25px;
        min-height: 80vh;
    }

    .page-title {
        font-size: 24px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 25px;
    }

    .filter-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .search-box {
        position: relative;
        flex-grow: 1;
        margin-right: 20px;
    }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 45px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            outline: none;
            font-size: 14px;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

    .btn-filter {
        border: 1px solid #e2e8f0;
        background: white;
        color: #4a5568;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s;
    }

        .btn-filter.active {
            background-color: #ebf8ff;
            color: #3182ce;
            border-color: #3182ce;
            font-weight: 600;
        }

        .btn-filter:hover {
            background-color: #edf2f7;
        }

    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

        .custom-table th {
            text-align: left;
            color: #718096;
            font-weight: 600;
            font-size: 13px;
            padding: 15px;
            border-bottom: 1px solid #edf2f7;
        }

        .custom-table td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #edf2f7;
            color: #2d3748;
            font-size: 14px;
        }

    .user-name {
        font-weight: 600;
        color: #2d3748;
    }

    .user-email {
        color: #718096;
        font-size: 13px;
    }

    .badge-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .badge-active {
        background-color: #c6f6d5;
        color: #22543d;
    }

    .badge-locked {
        background-color: #fed7d7;
        color: #822727;
    }

    /* Sửa nhẹ nút hành động để bấm được bằng JS */
    .action-icon {
        color: #718096;
        font-size: 16px;
        margin-left: 10px;
        cursor: pointer;
        transition: 0.2s;
        text-decoration: none;
        border: none;
        background: none;
    }

        .action-icon:hover {
            color: #3182ce;
        }

    .action-lock:hover {
        color: #e53e3e;
    }

    .action-unlock:hover {
        color: #38a169;
    }

    .custom-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
</style>

<div class="content-card">

    @using (Html.BeginForm("Index", "KhachHang", FormMethod.Get))
    {
        <div class="filter-wrapper">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" name="searchString" placeholder="Tìm kiếm theo tên, email, SĐT..." value="@Request.QueryString["searchString"]" />
            </div>

            <div style="display:flex; gap: 5px;">
                @{ string s = Request.QueryString["statusFilter"]; }
                <button type="submit" name="statusFilter" value="" class="btn-filter @(string.IsNullOrEmpty(s) ? "active" : "")">Tất cả</button>
                <button type="submit" name="statusFilter" value="active" class="btn-filter @(s == "active" ? "active" : "")">Hoạt động</button>
                <button type="submit" name="statusFilter" value="locked" class="btn-filter @(s == "locked" ? "active" : "")">Bị khóa</button>
            </div>
        </div>
    }

    <table class="custom-table">
        <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" class="custom-checkbox"></th>
                <th>Họ và Tên</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Ngày đăng ký</th>
                <th>Trạng thái</th>
                <th style="text-align: right;">Hành động</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                foreach (var item in Model)
                {
                    <tr>
                        <td><input type="checkbox" class="custom-checkbox"></td>
                        <td>
                            <div class="user-name">@item.HoTen</div>
                        </td>
                        <td class="user-email">@item.Email</td>
                        <td>@item.SoDienThoai</td>
                        <td>@item.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td>
                            @if (item.TrangThai)
                            {
                                <span class="badge-status badge-active">Hoạt động</span>
                            }
                            else
                            {
                                <span class="badge-status badge-locked">Bị khóa</span>
                            }
                        </td>
                        <td style="text-align: right;">
                            <a href="#" class="action-icon" title="Xem chi tiết"><i class="far fa-eye"></i></a>

                            @if (item.TrangThai)
                            {
                                <button type="button" class="action-icon action-lock" title="Khóa tài khoản" onclick="toggleStatus(@item.MaND, true)">
                                    <i class="fas fa-lock-open"></i>
                                </button>
                            }
                            else
                            {
                                <button type="button" class="action-icon action-unlock" title="Mở khóa tài khoản" onclick="toggleStatus(@item.MaND, false)">
                                    <i class="fas fa-lock"></i>
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px; color: #a0aec0;">
                        <i class="fas fa-users-slash" style="font-size: 40px; margin-bottom: 10px;"></i><br />
                        Không tìm thấy khách hàng nào.
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
        <span style="color: #718096; font-size: 14px;">Hiển thị @Model.Count() kết quả</span>
        <div>
            <button class="btn-filter">Trang trước</button>
            <button class="btn-filter">Trang sau</button>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Hàm Xử lý Khóa / Mở khóa
        function toggleStatus(id, willLock) {
            // willLock = true nghĩa là đang muốn Khóa
            // willLock = false nghĩa là đang muốn Mở Khóa

            var titleText = willLock ? 'Khóa tài khoản này?' : 'Mở khóa tài khoản?';
            var bodyText = willLock ? 'Người dùng sẽ không thể đăng nhập hệ thống.' : 'Người dùng sẽ hoạt động trở lại.';
            var btnText = willLock ? 'Khóa ngay' : 'Mở khóa';
            var btnColor = willLock ? '#e53e3e' : '#38a169'; // Đỏ hoặc Xanh
            var iconType = willLock ? 'warning' : 'question';

            Swal.fire({
                title: titleText,
                text: bodyText,
                icon: iconType,
                showCancelButton: true,
                confirmButtonColor: btnColor,
                cancelButtonColor: '#718096',
                confirmButtonText: btnText,
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hiển thị loading
                    Swal.fire({ title: 'Đang xử lý...', showConfirmButton: false, didOpen: () => { Swal.showLoading() } });

                    // Gọi AJAX về Controller
                    $.post('@Url.Action("ToggleStatus", "KhachHang")', { id: id })
                        .done(function (res) {
                            if (res.success) {
                                Swal.fire('Thành công!', res.message, 'success').then(() => location.reload());
                            } else {
                                Swal.fire('Lỗi', res.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Lỗi Server', 'Không thể kết nối API.', 'error');
                        });
                }
            });
        }
    </script>
}